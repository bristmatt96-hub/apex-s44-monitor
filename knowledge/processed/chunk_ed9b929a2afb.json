{
  "id": "ed9b929a2afb",
  "source": "Quantitative_Trading.pdf",
  "source_type": "pdf",
  "title": "Quantitative Trading",
  "chunk_index": 44,
  "content": "poorest in that month a year earlier. The average annual return before 2002 was more than 13 percent before transac- tion costs. However, I have found that this effect has disappeared since then, as you can check for yourself in Example 7.7. (See the readers\u2019 comments to my blog post epchan.blogspot.com/2007/11/ seasonal-trades-in-stocks.html.) sortidx <- order(annret[y, hasData]) # sort stocks based on prior year's returns topN <- round(length(hasData)/10) # buy stocks with lowest decile of returns, and vice versa for highest decile portRet <- (sum(janret[y, hasData[sortidx[1:topN]]], na.rm=TRUE)- sum(janret[y, hasData[sortidx[(length(sortidx)- topN+1):length(sortidx)]]], na.rm=TRUE))/2/ topN-2*onewaytcost # portfolio returns msg <- sprintf('Last holding date %s: Portfolio return=%7.4f\\n', as.character(exitDay[y+1]), portRet) cat(msg) } # Last holding date 2006-01-31: Portfolio return=-0.0244 # Last holding date 2007-01-31: Portfolio return=-0.0068 # Last holding date 2008-01-31: Portfolio return= 0.0881 Example 7.7: Backtesting a Year-on-Year Seasonal Trending Strategy Here are the codes for the year-on-year seasonal trending strategy I quoted earlier. Note that the data contains survivorship bias, as it is based on the S&P 500 index on November 23, 2007. Chan800064_c07.indd 179 6/7/2021 7:16:59 AM 95 This PDF file is part of the audiobook QUANTITATIVE TRADING and cannot be sold separately. It may not be reproduced, copied, circulated, or posted online. All rights reserved. Copyright \u00a9 Ernest P . Chan, 2021. Published by Echo Point Books & Media, LLC by arrangement with John Wiley & Sons, Inc. All Rights Reserved. 180 QUANTITATIVE TRADING Using MATLAB The source code can be downloaded from epchan.com/book/example7_7.m. The data is also available at that site. % % written by: clear; load('SPX_20071123', 'tday', 'stocks', 'cl'); monthEnds=find(isLastTradingDayOfMonth(tday)); % find the indices of the days that are at month ends. tday=tday(monthEnds); cl=cl(monthEnds, :); monthlyRet=(cl-lag1(cl))./lag1(cl); positions=zeros(size(monthlyRet)); for m=14:size(monthlyRet, 1) [monthlyRetSorted sortIndex]=sort(monthlyRet(m-12, :)); badData=find(~isfinite(monthlyRet(m-12, :)) | ~isfinite(cl(monthEnds(m-1), :))); sortIndex=setdiff(sortIndex, badData, 'stable'); topN=floor(length(sortIndex)/10); % take top decile of stocks as longs, bottom decile as shorts positions(m-1, sortIndex(1:topN))=-1; positions(m-1, sortIndex(end-topN+1:end))=1; end ret=smartsum(lag1(positions).*monthlyRet, 2)./ smartsum(abs(lag1(positions)), 2); ret(1:13)=[]; avgannret=12*smartmean(ret); sharpe=sqrt(12)*smartmean(ret)/smartstd(ret); fprintf(1, 'Avg ann return=%7.4f Sharpe ratio=%7.4f\\n', avgannret, sharpe); % Output should be % Avg ann return=-0.0129 Sharpe ratio=-0.1243 This program contains a few utility functions. The first one is Last- TradingDayOfMonth, which returns a logical array of 1s and 0s, indicating whether a month in a trading-date array is the last trading day of a month. Chan800064_c07.indd 180 6/7/2021 7:16:59 AM 96 This PDF file is part of the audiobook QUANTITATIVE TRADING and cannot be sold separately. It may not be reproduced, copied, circulated, or posted online. All rights reserved. Copyright \u00a9 Ernest P . Chan, 2021. Published by Echo Point Books & Media, LLC by arrangement with John Wiley & Sons, Inc. All Rights Reserved. Special Topics in Quantitative Trading 181 function isLastTradingDayOfMonth=.. isLastTradingDayOfMonth(tday) % isLastTradingDayOfMonth= % isLastTradingDayOfMonth(tday) returns a logical % array. True if tday(t) is last trading day of month. tdayStr=datestr(datenum(num2str(tday), 'yyyymmdd')); todayMonth=month(tdayStr); tmrMonth=fwdshift(1, todayMonth); % tomorrow's month isLastTradingDayOfMonth=false(size(tday)); isLastTradingDayOfMonth(todayMonth~=tmrMonth & .. isfinite(todayMonth) & isfinite(tmrMonth))=true; Another is the backshift function, which is like the lag1 function except that one can shift any arbitrary number of periods instead of just 1. function y=backshift(day,x) % y=backshift(day,x) assert(day>=0); y=[NaN(day,size(x,2), size(x, 3));x(1:end-day,:,:)]; You can try the most recent five years instead of the entire data period, and you will find that the average returns are even worse. Using Python # Backtesting a Year-on-Year Seasonal Trending Strategy import numpy as np import pandas as pd df=pd.read_table('SPX_20071123.txt') df['Date']=df['Date'].round().astype('int') df['Date']=pd.to_datetime(df['Date'], format='%Y%m%d') df.set_index('Date', inplace=True) eomPrice=df.resample('M').last()[:-1] # End of month prices. Need to remove last date because it isn't really end of January. monthlyRet=eomPrice.pct_change(1, fill_method=None) positions=np.zeros(monthlyRet.shape) for m in range(13, monthlyRet.shape[0]): hasData=np.where(np.isfinite(monthlyRet.iloc[m-12, :]))[0] sortidx=np.argsort(monthlyRet.iloc[m-12, hasData]) badData=np.where(np.logical_not(np. isfinite(monthlyRet.iloc[m-1, hasData[sortidx]]))) [0] # these are indices sortidx.drop(sortidx.index[badData], inplace=True) topN=np.floor(len(sortidx)/10).astype('int') Chan800064_c07.indd 181 6/7/2021 7:16:59 AM 97 This PDF file is part of the audiobook QUANTITATIVE TRADING and cannot be sold separately. It may not be reproduced, copied, circulated, or posted online. All rights reserved. Copyright \u00a9 Ernest P . Chan, 2021. Published by Echo Point Books & Media, LLC by arrangement with John Wiley & Sons, Inc. All Rights Reserved. 182 QUANTITATIVE TRADING positions[m-1, hasData[sortidx.values[np.arange(0, topN)]]]=-1 positions[m-1, hasData[sortidx.values[np.arange(- topN,0)]]]=1 capital=np.nansum(np.array(pd.DataFrame(abs(positions)). shift()), axis=1) capital[capital==0]=1 ret=np.nansum(np.array(pd.DataFrame(positions). shift())*np.array(monthlyRet), axis=1)/capital ret=np.delete(ret, np.arange(13)) avgret=np.nanmean(ret)*12 sharpe=np.sqrt(12)*np.nanmean(ret)/np.nanstd(ret) print('Avg ann return=%f Sharpe ratio=%f' % (avgret, sharpe)) #Avg ann return=-0.012679 Sharpe ratio=-0.122247 Using R The source code can be downloaded as example7_7.R. # Need the lubridate package for its dates handling install.packages('lubridate') library('lubridate') source('calculateReturns.R') source('backshift.R') source('fwdshift.R') data1 <- read.delim(\"SPX_20071123.txt\") # Tab-delimited cl <- data.matrix(data1[, 2:ncol(data1)]) tday <- ymd(data.matrix(data1[, 1])) # dates in lub- ridate format years <- year(tday) months <- month(tday) years <- as.matrix(years, length(years), 1) months <- as.matrix(months, length(months), 1) nextdaymonth <- fwdshift(1, months) eom <- which(months!=nextdaymonth) # End of month indices. monret <- calculateReturns(cl[eom,], 1) # monthly returns positions <- matrix(0, nrow(monret), ncol(monret)) for (m in 14:nrow(monret)) { prevYearSortIdx <- order(monret[m-12,], na.last = NA) prevYearSortIdx <- setdiff(prevYearSortIdx, which(!is. finite(cl[eom[m-1],]))) # Note setdiff in R does not re-sort data. It is equivalent to setdiff(x, y, 'stable') in Matlab Chan800064_c07.indd 182 6/7/2021 7:16:59 AM 98 This PDF file is part of the audiobook QUANTITATIVE TRADING and cannot be sold separately. It may not be reproduced, copied, circulated, or posted online. All rights reserved. Copyright \u00a9 Ernest P . Chan, 2021. Published by Echo Point Books & Media, LLC by arrangement with John Wiley & Sons, Inc. All Rights Reserved. Special Topics in Quantitative Trading 183 In contrast to equity seasonal strategies, commodity futures\u2019 seasonal strategies are alive and well. That is perhaps because sea- sonal demand for certain commodities is driven by \u201creal\u201d economic needs rather than speculations. One of the most intuitive commodity seasonal trades is the gasoline future trade: Simply buy the gasoline future contract that expires in May near the middle of April, and sell it by the end of April. This trade has been profitable for 19 of the last 21 years, as of 2015, the last 9 of which are out of sample (see the sidebar for details). It appears that one can always depend on approaching sum- mer driving seasons in North America to drive up gasoline futures prices in the spring. topN <- round(length(prevYearSortIdx)/10) # buy",
  "word_count": 1000,
  "topics": [
    "technical_analysis",
    "options",
    "psychology",
    "strategies",
    "macro"
  ],
  "created_at": "2026-02-05T00:37:43.610938"
}