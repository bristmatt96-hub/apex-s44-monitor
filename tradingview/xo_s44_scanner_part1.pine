// XO S44 Credit Monitor - Scanner Part 1 (21 tickers)
// Alerts on +/- 1% move in 2 minutes
// @version=5
indicator("XO S44 Scanner Part 1", overlay=false)

// Settings
threshold = input.float(1.0, "Alert Threshold % (absolute)", minval=0.1, maxval=10, step=0.1)

// Function to get 2-minute change %
getChange(sym) =>
    [c, pc] = request.security(sym, "2", [close, close[1]], ignore_invalid_symbol=true)
    na(c) or na(pc) ? na : ((c - pc) / pc) * 100

// XO S44 Tickers - Part 1 (European focus)
chg01 = getChange("EURONEXT:AF")      // Air France-KLM
chg02 = getChange("XETR:CEC")         // Ceconomy
chg03 = getChange("SIX:AVOL")         // Avolta
chg04 = getChange("BME:GRF")          // Grifols
chg05 = getChange("NYSE:IGT")         // IGT
chg06 = getChange("EURONEXT:MMB")     // Lagardère
chg07 = getChange("MIL:LTMC")         // Lottomatica
chg08 = getChange("EURONEXT:ONTEX")   // Ontex
chg09 = getChange("LSE:PTEC")         // Playtech
chg10 = getChange("LSE:PFD")          // Premier Foods
chg11 = getChange("MIL:REC")          // Recordati
chg12 = getChange("LSE:TUI")          // TUI
chg13 = getChange("LSE:WIZZ")         // Wizz Air
chg14 = getChange("NYSE:CSTM")        // Constellium
chg15 = getChange("NYSE:CCK")         // Crown Holdings
chg16 = getChange("EURONEXT:FRVIA")   // Forvia
chg17 = getChange("XETR:HLAG")        // Hapag-Lloyd
chg18 = getChange("NSE:TATAMOTORS")   // Tata Motors (JLR)
chg19 = getChange("XETR:LXS")         // Lanxess
chg20 = getChange("OMXHEX:METSB")     // Metsä Board
chg21 = getChange("NYSE:OI")          // O-I Glass

// Ticker names and symbols
var string[] names = array.from("Air France", "Ceconomy", "Avolta", "Grifols", "IGT", "Lagardere", "Lottomatica", "Ontex", "Playtech", "Premier Foods", "Recordati", "TUI", "Wizz Air", "Constellium", "Crown", "Forvia", "Hapag-Lloyd", "Tata/JLR", "Lanxess", "Metsa Board", "OI Glass")
var string[] tickers = array.from("AF", "CEC", "AVOL", "GRF", "IGT", "MMB", "LTMC", "ONTEX", "PTEC", "PFD", "REC", "TUI", "WIZZ", "CSTM", "CCK", "FRVIA", "HLAG", "TATAMOTORS", "LXS", "METSB", "OI")

// Check if triggered
isTriggered(chg) => not na(chg) and math.abs(chg) >= threshold

// Check triggers
t01 = isTriggered(chg01)
t02 = isTriggered(chg02)
t03 = isTriggered(chg03)
t04 = isTriggered(chg04)
t05 = isTriggered(chg05)
t06 = isTriggered(chg06)
t07 = isTriggered(chg07)
t08 = isTriggered(chg08)
t09 = isTriggered(chg09)
t10 = isTriggered(chg10)
t11 = isTriggered(chg11)
t12 = isTriggered(chg12)
t13 = isTriggered(chg13)
t14 = isTriggered(chg14)
t15 = isTriggered(chg15)
t16 = isTriggered(chg16)
t17 = isTriggered(chg17)
t18 = isTriggered(chg18)
t19 = isTriggered(chg19)
t20 = isTriggered(chg20)
t21 = isTriggered(chg21)

// Count triggers
triggerCount = (t01 ? 1 : 0) + (t02 ? 1 : 0) + (t03 ? 1 : 0) + (t04 ? 1 : 0) + (t05 ? 1 : 0) + (t06 ? 1 : 0) + (t07 ? 1 : 0) + (t08 ? 1 : 0) + (t09 ? 1 : 0) + (t10 ? 1 : 0) + (t11 ? 1 : 0) + (t12 ? 1 : 0) + (t13 ? 1 : 0) + (t14 ? 1 : 0) + (t15 ? 1 : 0) + (t16 ? 1 : 0) + (t17 ? 1 : 0) + (t18 ? 1 : 0) + (t19 ? 1 : 0) + (t20 ? 1 : 0) + (t21 ? 1 : 0)

anyAlert = triggerCount > 0

// Build alert message
getMsg(triggered, chg, idx) =>
    triggered ? str.format('\{"ticker":"{0}","company":"{1}","price":0,"change":{2,number,#.##}\}', array.get(tickers, idx), array.get(names, idx), chg) : ""

firstMsg = t01 ? getMsg(t01, chg01, 0) : t02 ? getMsg(t02, chg02, 1) : t03 ? getMsg(t03, chg03, 2) : t04 ? getMsg(t04, chg04, 3) : t05 ? getMsg(t05, chg05, 4) : t06 ? getMsg(t06, chg06, 5) : t07 ? getMsg(t07, chg07, 6) : t08 ? getMsg(t08, chg08, 7) : t09 ? getMsg(t09, chg09, 8) : t10 ? getMsg(t10, chg10, 9) : t11 ? getMsg(t11, chg11, 10) : t12 ? getMsg(t12, chg12, 11) : t13 ? getMsg(t13, chg13, 12) : t14 ? getMsg(t14, chg14, 13) : t15 ? getMsg(t15, chg15, 14) : t16 ? getMsg(t16, chg16, 15) : t17 ? getMsg(t17, chg17, 16) : t18 ? getMsg(t18, chg18, 17) : t19 ? getMsg(t19, chg19, 18) : t20 ? getMsg(t20, chg20, 19) : t21 ? getMsg(t21, chg21, 20) : ""

// REQUIRED: Plot and hline at top level
plot(triggerCount, "Triggers", color=triggerCount > 0 ? color.red : color.green, linewidth=2)
hline(0, "Zero", color=color.gray)

// Alert condition
alertcondition(anyAlert, title="XO S44 Alert", message="{{plot_0}}")

// Alternative alert method
if anyAlert
    alert(firstMsg, alert.freq_once_per_bar)

// Table display
var table infoTable = table.new(position.top_right, 2, 22, bgcolor=color.new(color.black, 80))
if barstate.islast
    table.cell(infoTable, 0, 0, "XO S44 Part 1 (2m)", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 1, 0, "2m Chg %", text_color=color.white, text_size=size.small)

    for i = 0 to 20
        chgVal = i == 0 ? chg01 : i == 1 ? chg02 : i == 2 ? chg03 : i == 3 ? chg04 : i == 4 ? chg05 : i == 5 ? chg06 : i == 6 ? chg07 : i == 7 ? chg08 : i == 8 ? chg09 : i == 9 ? chg10 : i == 10 ? chg11 : i == 11 ? chg12 : i == 12 ? chg13 : i == 13 ? chg14 : i == 14 ? chg15 : i == 15 ? chg16 : i == 16 ? chg17 : i == 17 ? chg18 : i == 18 ? chg19 : i == 19 ? chg20 : chg21
        c = na(chgVal) ? color.gray : math.abs(chgVal) >= threshold ? color.red : chgVal < 0 ? color.orange : color.green
        table.cell(infoTable, 0, i + 1, array.get(names, i), text_color=c, text_size=size.tiny)
        table.cell(infoTable, 1, i + 1, na(chgVal) ? "N/A" : str.tostring(chgVal, "#.##") + "%", text_color=c, text_size=size.tiny)
